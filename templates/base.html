<!-- templates/base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}Working Time{% endblock %}</title>
</head>
<body>
<header>
    <h1>Working Time Dashboard</h1>
</header>

<main>
    {% block content %}
    {% endblock %}
</main>

<script>
    const currencyMapping = {
        US: { name: "USD", symbol: "($)" },
        AU: { name: "AUD", symbol: "(A$)" },
        DE: { name: "EUR", symbol: "(€)" },
        GB: { name: "GBP", symbol: "(£)" },
        CA: { name: "CAD", symbol: "(C$)" }
    };

    const incomeMapping = {
        US: { gross: 5000, net: 4000 },
        AU: { gross: 7000, net: 5500 },
        DE: { gross: 4500, net: 3000 },
        GB: { gross: 4800, net: 3500 },
        CA: { gross: 5200, net: 4000 }
    };

    const countryCodeFromServer = "{{ country_code | default('') }}";
    let states = {};

    document.addEventListener("DOMContentLoaded", () => {
        fetch("{{ url_for('static', filename='states.json') }}")
            .then(response => response.json())
            .then(data => {
                states = data;

                // ✅ 加载完 states 后才填充下拉
                if (countryCodeFromServer && states[countryCodeFromServer]) {
                    populateStates(countryCodeFromServer);
                    setIncomeAndCurrency(countryCodeFromServer);
                }

                // 如果有手动选择国家的 select（首页），监听变化
                const countrySelect = document.getElementById("country");
                if (countrySelect) {
                    countrySelect.addEventListener("change", () => {
                        const selectedCountry = countrySelect.value;
                        populateStates(selectedCountry);
                        setIncomeAndCurrency(selectedCountry);
                    });
                }

                const stateSelect = document.getElementById("state");
                if (stateSelect) {
                    stateSelect.addEventListener("change", () => {
                        const selectedCountry = countryCodeFromServer || countrySelect?.value;
                        if (selectedCountry) {
                            setIncomeAndCurrency(selectedCountry);
                        }
                    });
                }
            });
    });

    function populateStates(country) {
        const stateSelect = document.getElementById("state");
        if (!stateSelect || !states[country]) return;

        stateSelect.innerHTML = ""; // 清空旧的
        states[country].forEach(state => {
            const option = document.createElement("option");
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });
    }

    function setIncomeAndCurrency(country) {
        const currency = currencyMapping[country];
        const defaultIncome = incomeMapping[country];

        if (!currency || !defaultIncome) return;

        const grossInput = document.getElementById("gross_income");
        const netInput = document.getElementById("net_income");

        if (grossInput) {
            grossInput.value = defaultIncome.gross;
            grossInput.placeholder = `Gross Income in ${currency.name}`;
        }
        if (netInput) {
            netInput.value = defaultIncome.net;
            netInput.placeholder = `Net Income in ${currency.name}`;
        }

        const grossSymbol = document.getElementById("currency-symbol-gross");
        const netSymbol = document.getElementById("currency-symbol-net");
        if (grossSymbol) grossSymbol.textContent = currency.symbol;
        if (netSymbol) netSymbol.textContent = currency.symbol;
    }
</script>
</body>
</html>